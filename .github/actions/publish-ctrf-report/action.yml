name: Publish CTRF report
description: Convert JUnit to CTRF (optional) and publish CTRF report with Insights.
inputs:
  junit-path:
    description: Path to the JUnit XML report.
    required: false
    default: ""
  tool:
    description: Tool name for the CTRF report (e.g. playwright, vitest, node-test).
    required: false
    default: "junit"
  github-token:
    description: GitHub token for publishing CTRF reports.
    required: true

runs:
  using: composite
  steps:
    - name: Resolve CTRF artifact name
      id: ctrf-artifact
      shell: bash
      run: |
        if [ -n "${{ inputs.junit-path }}" ]; then
          junit_path="${{ inputs.junit-path }}"
          base_name=$(basename "$junit_path")
          base_name="${base_name%.xml}"
          echo "name=ctrf-${base_name}" >> "$GITHUB_OUTPUT"
        else
          job_name="${GITHUB_JOB:-ctrf-report}"
          echo "name=ctrf-${job_name}" >> "$GITHUB_OUTPUT"
        fi

    - name: Convert JUnit to CTRF
      if: ${{ inputs.junit-path != '' }}
      shell: bash
      run: |
        junit_path="${{ inputs.junit-path }}"
        if [ -f "$junit_path" ]; then
          base_name=$(basename "$junit_path")
          base_name="${base_name%.xml}"
          output_path="ctrf/${base_name}.json"
          pnpm dlx junit-to-ctrf "$junit_path" \
            -o "$output_path" \
            -t "${{ inputs.tool }}"
        else
          echo "JUnit report not found at $junit_path"
        fi

    - name: Publish Test Report with Insights
      uses: ctrf-io/github-test-reporter@v1
      with:
        report-path: './ctrf/*.json'
        summary-delta-report: true
        insights-report: true
        flaky-rate-report: true
        fail-rate-report: true
        slowest-report: true
        upload-artifact: true
        artifact-name: ${{ steps.ctrf-artifact.outputs.name }}
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
