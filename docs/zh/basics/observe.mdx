---
title: Observe
sidebarTitle: Observe
description: "为你的工作流查找推荐的操作"
---

## 什么是 `observe()`？

```typescript
page.observe("Find the login button")
```

`observe()` 让你把任何页面变成一份可靠、可执行动作的清单。它会发现关键元素、为可能的下一步操作排序，并返回结构化动作（selector、method、args）。这些动作可直接交给 `act()` 立即执行，或用于精准驱动 `extract()`，使工作流更快、更省成本、更稳健。

## 为什么使用 `observe()`？

<CardGroup cols={2}>
  <Card title="探索" icon="compass" href="/zh/basics/observe#observe-with-act">
    当你不确定页面内容，或需要发现可执行的动作时
  </Card>

  <Card title="规划" icon="map" href="/zh/basics/observe#plan-ahead">
    在构建复杂工作流时，预先规划所有需要执行的动作
  </Card>

  <Card title="缓存" icon="database" href="/zh/best-practices/caching">
    当你希望复用已知动作并避免 LLM 调用时
  </Card>

  <Card title="验证" icon="check" href="/zh/basics/observe#observe-with-act">
    在执行关键动作前，先确保相关元素存在
  </Card>
</CardGroup>

## 使用 `observe()`

调用 `observe` 能为其他 Stagehand 方法提供强大助力。用它来规划工作流、加速 `act`，并精准定位 `extract`。`observe` 会返回一组建议操作，帮助你探索页面上可执行的动作。

<CodeGroup>
  ```typescript TypeScript
  // Plan & validate
  const buttons = await page.observe("Find the log in / sign up buttons");
  ```

  ```python Python
  # Plan & validate
  buttons = await page.observe("Find the log in / sign up buttons")
  ```
</CodeGroup>

它会返回一个具有如下结构的建议列表

```json
{
  "selector": "xpath=/html/body/header/div/button[1]",
  "description": "Log in button in the top right corner",
  "method": "click",
  "arguments": []
}
```

### Observe 与 Act 搭配

你可以先对动作（method、selector、arguments 等）进行验证，然后将其传递给 `act`，以避免额外的 LLM 推理。

<Note>
  **性能提示**：基于多个 `observe` 建议直接执行操作，可以在多步任务中最小化 LLM 调用次数，将工作流加速 2-3 倍。
</Note>

<CodeGroup>
  ```typescript TypeScript
  await page.act(buttons[0]); // No LLM!
  ```

  ```python Python
  await page.act(buttons[0]) # No LLM!
  ```
</CodeGroup>

#### 提前规划

你可以利用 `observe` 的多条建议来预览并批量执行动作。例如，在填写表单时，让 `observe` 找到全部字段，然后逐一交给 `act`。**LLM 只调用一次，act 可多次执行**。

<CodeGroup>
  ```typescript TypeScript
  const fields = await page.observe("Find all the fields in the form");
  for (const field of fields) {
    await page.act(field); // No LLM!
  }
  ```

  ```python Python
  fields = await page.observe("Find all the fields in the form")
  for field in fields:
    await page.act(field) # No LLM!
  ```
</CodeGroup>

### Observe 与 Extract 搭配

使用 `observe` 将 `extract` 聚焦到页面的特定区域（如表格、表单、列表等），可显著减少提取所需的上下文。

<Tip>
  **成本节省**：将 selector 传入 `extract`，在内容冗长的网站上可将 LLM Token 使用量降低 10 倍！
</Tip>

<CodeGroup>
  ```typescript TypeScript
  // Use observe to validate elements before extraction
  const [ table ] = await page.observe("Find the data table");

  const { data } = await page.extract({
    instruction: "Extract data from the table",
    schema: z.object({
      data: z.string()
    }),
    selector: table.selector // Reduce context scope needed for extraction
  });
  ```

  ```python Python
  # Use observe to validate elements before extraction
  [ table ] = await page.observe("Find the data table")

  extraction = await page.extract(
    "Extract data from the table",
    schema=Data, # Pydantic schema
    selector=table.selector # Reduce context scope needed for extraction
  )
  ```
</CodeGroup>

## 最佳实践

### 选择合适的命令

<Tabs>
  <Tab title="正确示例">
    - 当是/否答案会决定是否执行某个动作时使用 `observe`（例如，“Find the Submit button”），然后按条件调用 `act`。
    - 针对纯信息查询使用 `extract`（例如，“What’s the page title?”、“How many results are listed?”）。
  </Tab>

  <Tab title="不要这样做">
    - 不要为了定位下步要点击的元素而调用 `extract`。
    - 不要为不会引发后续动作的纯信息问题调用 `observe`。
  </Tab>
</Tabs>

- 使用 **`observe` 进行发现与规划**：通过 `observe("Find…")` 映射可操作元素，并预览下一步。
- **用来自 `observe` 的选择器限定 `extract` 的范围**：先执行 `observe("Find the data table")`，再将返回的 `selector` 传给 `extract`，以减少 token 消耗并提升准确性。

### 节省 LLM token

通过将 `ObserveResult` 直接传给 `act`（例如 `await page.act(results[0])`）来优化性能，节省 LLM token。可先用一次 `observe` 找到所有元素，再逐一执行以实现批量操作。对于熟悉的页面，缓存并复用稳定的 `observe` 结果；若布局变化，启用自愈（Self‑healing）。

<Card title="构建你自己的缓存" icon="database" href="/zh/best-practices/caching">
  查看如何构建你自己的动作缓存
</Card>

### 提升准确性

提供更精确的指令，例如 “Find the primary CTA in the hero”，以获得更好的结果。针对 iframe，设置 `iframes: true` 并等待 `networkidle`。在 `extract` 中使用来自 `observe` 的选择器以缩小上下文。

<Card title="提示词最佳实践" icon="robot" href="/zh/best-practices/prompting-best-practices">
  查看如何提升结果准确性的指南
</Card>

### 动作校验

在执行关键动作前，校验建议的 `method`、`selector` 和 `arguments`，以防误点。如果直接 `act` 失败，使用相同的提示调用 `observe` 验证方法，然后按建议的动作继续。

<CodeGroup>
  ```typescript TypeScript
  const prompt = "click the submit button";
  const expectedMethod = "click";

  try {
    await page.act(prompt);
  } catch (error) {
    if (error.message.includes("method not supported")) {
      // 观察同一提示以获取计划的动作
      const [action] = await page.observe(prompt);
      
      if (action && action.method === expectedMethod) {
        await page.act(action);
      } else {
        throw new Error(`Unsupported method: expected "${expectedMethod}", got "${action?.method}"`);
      }
    } else {
      throw error;
    }
  }
  ```

  ```python Python
  prompt = "click the submit button"
  expected_method = "click"

  try:
      await page.act(prompt)
  except Exception as error:
      if "method not supported" in str(error):
          # 观察同一提示以获取计划的动作
          results = await page.observe(prompt)
          
          if results and results[0].method == expected_method:
              await page.act(results[0])
          else:
              method = results[0].method if results else "unknown"
              raise Exception(f'Unsupported method: expected "{expected_method}", got "{method}"')
      else:
          raise error
  ```
</CodeGroup>

## 故障排查

<AccordionGroup>
  <Accordion title="未找到元素">
    **问题**：`observe` 返回空数组

    **解决方案**：

    - 确认页面上确实存在该元素
    - 提供更明确的定位指令
    - 确保页面已完全加载
    - 查看[调试工作流](/zh/best-practices/debugging-workflows)日志；如果日志中能看到该元素，则可能是 LLM 产生幻觉/未能识别。
  </Accordion>

  <Accordion title="元素描述不准确">
    **问题**：描述与实际元素不匹配

    **解决方案**：

    - 使用更强的模型：查看 [评估套件与仪表盘（比较 Stagehand 任务的模型性能/成本）](https://stagehand.dev/evals)，选择最适合你的用例的模型
    - 提供更具体的指令
    - 将推理过程记录到文件（参见[调试工作流](/zh/best-practices/debugging-workflows)），以获取 LLM 追踪
  </Accordion>

  <Accordion title="识别的方法不正确">
    **问题**：识别到的方法无效

    **解决方案**：

    - 查看[支持的动作](/zh/basics/act)
    - 提供更具体的指令
    - 校验该方法；如果无效，请改用受支持的方法之一
  </Accordion>
</AccordionGroup>

## 后续步骤

<CardGroup cols={2}>
  <Card title="Act 概览" icon="play" href="/zh/basics/act">
    使用 observe() 结果高效执行操作
  </Card>

  <Card title="提取数据" icon="download" href="/zh/basics/extract">
    从已观测的元素中提取结构化数据
  </Card>

  <Card title="可观测性" icon="chart-line" href="/zh/configuration/observability">
    监控与调试观测性能
  </Card>

  <Card title="最佳实践" icon="star" href="/zh/best-practices/best-practices">
    高级模式与优化技巧
  </Card>
</CardGroup>
